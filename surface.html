<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>X3P Ballistic Surface Comparison</title>
    <link
      href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

    <style>
      /* Custom styles for X3P Ballistic Surface Comparison */

      /* Ensure proper spacing and layout */
      .container {
        max-width: 1200px;
      }

      /* Loading spinner enhancement */
      .spinner-border {
        width: 3rem;
        height: 3rem;
      }

      /* Results cards styling */
      .card.bg-primary .card-body,
      .card.bg-info .card-body {
        color: white;
      }

      .card.bg-primary .card-title,
      .card.bg-info .card-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
      }

      /* Code blocks styling */
      pre {
        font-size: 0.875rem;
        overflow-x: auto;
      }

      code {
        font-size: 0.875rem;
      }

      /* Form styling improvements */
      .form-label {
        font-weight: 500;
      }

      .form-text {
        font-size: 0.875rem;
      }

      /* Alert styling for match assessment */
      .alert h5 {
        margin-bottom: 0.5rem;
      }

      /* Table styling for metrics */
      .table-responsive {
        border-radius: 0.375rem;
        overflow: hidden;
      }

      /* Analysis details styling */
      #analysisDetails {
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
      }

      /* Button styling */
      .btn {
        font-weight: 500;
      }

      /* Card header styling */
      .card-header .card-title {
        color: var(--bs-body-color);
      }

      /* Responsive adjustments */
      @media (max-width: 768px) {
        .display-4 {
          font-size: 2rem;
        }

        .col-md-6 .card {
          margin-bottom: 1rem;
        }

        pre {
          font-size: 0.75rem;
        }
      }

      /* Loading state styling */
      #loadingState .card-body {
        padding: 3rem 1.5rem;
      }

      /* Error section styling */
      #errorSection {
        border: none;
        border-left: 4px solid var(--bs-danger);
      }

      /* Smooth transitions */
      .card,
      .alert,
      .btn {
        transition: all 0.3s ease;
      }

      /* Hover effects */
      .btn:hover {
        transform: translateY(-1px);
      }

      .card:hover {
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row justify-content-center">
        <div class="col-lg-10">
          <!-- Header -->
          <div class="text-center mb-5">
            <h1 class="display-4 mb-3">
              <i class="fas fa-microscope me-3"></i>
              X3P Ballistic Surface Comparison
            </h1>
            <p class="lead text-muted">
              Advanced surface comparison API for ballistic analysis using X3P
              file format
            </p>
          </div>
          <div class="mb-3">
            <input type="file" id="file1" class="form-control" />
            <input type="file" id="file2" class="form-control mt-2" />
            <button onclick="uploadAndCompare()" class="btn btn-primary mt-3">
              Karşılaştır
            </button>
          </div>
          <!-- API Testing Interface -->
          <div class="card mb-5">
            <div class="card-header">
              <h3 class="card-title mb-0">
                <i class="fas fa-play-circle me-2"></i>
                API Test Interface
              </h3>
            </div>
            <div class="card-body">
              <div id="comparisonForm">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <label for="url1" class="form-label"
                      >First X3P File URL</label
                    >
                    <input
                      type="url"
                      class="form-control"
                      id="url1"
                      placeholder="https://your-supabase-storage-url/file1.x3p"
                      required
                    />
                    <div class="form-text">
                      Supabase storage URL for the first X3P file
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="url2" class="form-label"
                      >Second X3P File URL</label
                    >
                    <input
                      type="url"
                      class="form-control"
                      id="url2"
                      placeholder="https://your-supabase-storage-url/file2.x3p"
                      required
                    />
                    <div class="form-text">
                      Supabase storage URL for the second X3P file
                    </div>
                  </div>
                </div>

                <pre id="output"></pre>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button
                    onclick="compareFromUrl()"
                    class="btn btn-primary"
                    id="compareBtn"
                  >
                    <i class="fas fa-analytics me-2"></i>
                    Compare Surfaces
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-secondary"
                    id="clearBtn"
                  >
                    <i class="fas fa-eraser me-2"></i>
                    Clear
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div id="loadingState" class="card mb-5" style="display: none">
            <div class="card-body text-center">
              <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <h5>Processing X3P Files...</h5>
              <p class="text-muted">
                This may take a few moments depending on file size
              </p>
            </div>
          </div>

          <!-- Results Section -->
          <div id="resultsSection" class="card mb-5" style="display: none">
            <div class="card-header">
              <h3 class="card-title mb-0">
                <i class="fas fa-chart-line me-2"></i>
                Comparison Results
              </h3>
            </div>
            <div class="card-body">
              <!-- Similarity Score -->
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="card bg-primary">
                    <div class="card-body text-center">
                      <h2 class="card-title" id="similarityScore">--</h2>
                      <p class="card-text">Similarity Score (%)</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card bg-info">
                    <div class="card-body text-center">
                      <h3 class="card-title" id="correlationCoeff">--</h3>
                      <p class="card-text">Correlation Coefficient</p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Statistical Metrics -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5>Statistical Metrics</h5>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <tbody id="statisticalMetrics">
                        <!-- Populated by JavaScript -->
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Analysis Details -->
              <div class="row mb-4">
                <div class="col-12">
                  <h5>Analysis Details</h5>
                  <div id="analysisDetails" class="bg-dark p-3 rounded">
                    <!-- Populated by JavaScript -->
                  </div>
                </div>
              </div>

              <!-- Match Assessment -->
              <div class="alert" id="matchAssessment" role="alert">
                <!-- Populated by JavaScript -->
              </div>
            </div>
          </div>

          <!-- Error Section -->
          <div
            id="errorSection"
            class="alert alert-danger"
            style="display: none"
            role="alert"
          >
            <h5 class="alert-heading">
              <i class="fas fa-exclamation-triangle me-2"></i>
              Error
            </h5>
            <p id="errorMessage"></p>
          </div>

          <!-- API Documentation -->
          <div class="card">
            <div class="card-header">
              <h3 class="card-title mb-0">
                <i class="fas fa-book me-2"></i>
                API Documentation
              </h3>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <h5>Endpoint</h5>
                  <code>POST /api/compare</code>

                  <h5 class="mt-3">Request Body</h5>
                  <pre class="bg-dark p-3 rounded"><code>{
  "url1": "https://storage-url/file1.x3p",
  "url2": "https://storage-url/file2.x3p"
}</code></pre>
                </div>
                <div class="col-md-6">
                  <h5>Response</h5>
                  <pre class="bg-dark p-3 rounded"><code>{
  "success": true,
  "similarity_score": 85.2,
  "correlation_coefficient": 0.8751,
  "statistical_metrics": {...},
  "analysis_details": {...}
}</code></pre>
                </div>
              </div>

              <div class="mt-4">
                <h5>Health Check</h5>
                <code>GET /api/health</code>
                <p class="text-muted mt-2">
                  Check if the API service is running properly.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Firebase
      const firebaseConfig = {
        apiKey: 'AIzaSyCBM_rIBwuBlm3UkvCd_R5UcBrGzHMd4so',
        authDomain: 'askque-729f3.firebaseapp.com',
        projectId: 'askque-729f3',
        storageBucket: 'askque-729f3.appspot.com',
        messagingSenderId: '218092354672',
        appId: '1:218092354672:web:226cb9c767058face1c8b5',
        measurementId: 'G-THZX3Y5C24',
      };

      firebase.initializeApp(firebaseConfig);
      firebase.auth().onAuthStateChanged(function (user) {
        if (!user) {
          // Giriş yapılmamışsa login sayfasına yönlendir
          window.location.href = 'login.html';
        } else {
          // Giriş yapılmışsa kullanıcıyı karşılama (isteğe bağlı)
          document.querySelector(
            '.navbar-text'
          ).textContent = `Hoş geldiniz, ${user.email}!`;
        }
      });
      const supabaseClient = supabase.createClient(
        'https://wablvevlywlqifnezzdp.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhYmx2ZXZseXdscWlmbmV6emRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3OTM2ODksImV4cCI6MjA2NDM2OTY4OX0.IUJi55B60PLAlDE5rlLX0xutm7u4UYVR4HGCmWwDxE4'
      ); // Supabase client tanımlaması

      // DOM elementlerini önbelleğe al
      const loadingState = document.getElementById('loadingState');
      const resultsSection = document.getElementById('resultsSection');
      const errorSection = document.getElementById('errorSection');
      const errorMessage = document.getElementById('errorMessage');
      const compareBtn = document.getElementById('compareBtn'); // URL karşılaştırma butonu
      const fileUploadCompareBtn = document.querySelector(
        'button[onclick="uploadAndCompare()"]'
      ); // Dosya yükleme butonu // --- Yardımcı Fonksiyonlar (Tek Bir Kez Tanımlanır) ---

      function hideAllSections() {
        loadingState.style.display = 'none';
        resultsSection.style.display = 'none';
        errorSection.style.display = 'none';
      }

      function showError(message) {
        hideAllSections();
        errorMessage.textContent = message;
        errorSection.style.display = 'block';
      }

      function formatMetricName(name) {
        return name.replace(/_/g, ' ').replace(/\b\w/g, (l) => l.toUpperCase());
      }

      function displayResults(data) {
        hideAllSections(); // Update similarity score and correlation

        document.getElementById('similarityScore').textContent =
          (data.similarity_score !== undefined
            ? data.similarity_score.toFixed(2)
            : '--') + '%'; // .toFixed(2) ekledim
        document.getElementById('correlationCoeff').textContent =
          data.correlation_coefficient !== undefined
            ? data.correlation_coefficient.toFixed(4)
            : '--'; // .toFixed(4) ekledim // Update statistical metrics table

        const metricsTable = document.getElementById('statisticalMetrics');
        metricsTable.innerHTML = '';
        if (data.statistical_metrics) {
          Object.entries(data.statistical_metrics).forEach(([key, value]) => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${formatMetricName(key)}</td>
              <td><code>${value !== undefined ? value : '--'}</code></td>
            `;
            metricsTable.appendChild(row);
          });
        } else {
          metricsTable.innerHTML =
            '<tr><td colspan="2">No statistical metrics available.</td></tr>';
        } // Update analysis details

        const detailsDiv = document.getElementById('analysisDetails');
        detailsDiv.innerHTML = '';
        if (data.analysis_details) {
          Object.entries(data.analysis_details).forEach(([key, value]) => {
            const item = document.createElement('div');
            item.innerHTML = `<strong>${formatMetricName(key)}:</strong> ${
              value !== undefined ? value : '--'
            }`;
            item.className = 'mb-2';
            detailsDiv.appendChild(item);
          });
        } else {
          detailsDiv.innerHTML = 'No analysis details available.';
        } // Update match assessment

        const assessment = data.analysis_details
          ? data.analysis_details.match_assessment
          : 'N/A';
        const assessmentDiv = document.getElementById('matchAssessment');
        assessmentDiv.textContent = assessment; // Set alert class based on similarity score

        assessmentDiv.className = 'alert';
        if (data.similarity_score >= 80) {
          assessmentDiv.classList.add('alert-success');
        } else if (data.similarity_score >= 60) {
          assessmentDiv.classList.add('alert-warning');
        } else {
          assessmentDiv.classList.add('alert-danger');
        }

        resultsSection.style.display = 'block';
      } // --- end Yardımcı Fonksiyonlar --- // Dosya yükleme ve karşılaştırma fonksiyonu
      async function uploadAndCompare() {
        const file1 = document.getElementById('file1').files[0];
        const file2 = document.getElementById('file2').files[0];

        if (!file1 || !file2) {
          return alert('Lütfen karşılaştırmak için iki X3P dosyası seçin.');
        }

        hideAllSections();
        loadingState.style.display = 'block';
        fileUploadCompareBtn.disabled = true;

        try {
          // 1. Dosya 1 yüklemesi
          const { error: uploadErr1 } = await supabaseClient.storage
            .from('x3p-files')
            .upload(`input/${file1.name}`, file1, { upsert: true });

          if (uploadErr1) {
            console.error(uploadErr1);
            showError('Dosya 1 yüklenemedi: ' + uploadErr1.message);
            return;
          } // 2. Dosya 2 yüklemesi

          const { error: uploadErr2 } = await supabaseClient.storage
            .from('x3p-files')
            .upload(`input/${file2.name}`, file2, { upsert: true });

          if (uploadErr2) {
            console.error(uploadErr2);
            showError('Dosya 2 yüklenemedi: ' + uploadErr2.message);
            return;
          } // 3. Signed URL alma (60 saniye geçerli)

          const { data: signed1, error: urlErr1 } = await supabaseClient.storage
            .from('x3p-files')
            .createSignedUrl(`input/${file1.name}`, 60);

          const { data: signed2, error: urlErr2 } = await supabaseClient.storage
            .from('x3p-files')
            .createSignedUrl(`input/${file2.name}`, 60);

          if (
            urlErr1 ||
            urlErr2 ||
            !signed1?.signedUrl ||
            !signed2?.signedUrl
          ) {
            console.error(urlErr1 || urlErr2);
            showError(
              'Signed URL alınamadı. Policy veya dosya hatası olabilir. Lütfen Supabase Storage ayarlarınızı kontrol edin.'
            );
            return;
          }
          // 4. Supabase Edge Function çağır (Eğer kullanıyorsanız)
          const FUNCTION_URL =
            'https://wablvevlywlqifnezzdp.supabase.co/functions/v1/x3p-compare';
          // 4. Supabase Edge Function çağır
          const res = await fetch(FUNCTION_URL, {
            method: 'POST',
            body: JSON.stringify({
              url1: signed1.signedUrl,
              url2: signed2.signedUrl,
            }),
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const json = await res.json();
          document.getElementById('output').textContent = JSON.stringify(
            json,
            null,
            2
          );

          // 5. Replit Function çağır (Ana mantık buradaysa)
          const DEEP_FUNCTION_URL =
            'https://a961e274-de91-4411-bf3f-124d9d49d4fb-00-v2anh336mm9f.picard.replit.dev/api/compare';
          const deep_res = await fetch(DEEP_FUNCTION_URL, {
            method: 'POST',
            body: JSON.stringify({
              url1: signed1.signedUrl,
              url2: signed2.signedUrl,
            }),
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (!deep_res.ok) {
            const errorText = await deep_res.text();
            throw new Error(
              `Replit API error: ${deep_res.status} ${deep_res.statusText} - ${errorText}`
            );
          }

          const deep_json = await deep_res.json(); // Raw JSON çıktısını bir yere yazdır (isteğe bağlı, debug için)

          // document.getElementById('output').textContent = JSON.stringify(deep_json, null, 2);

          displayResults(deep_json);
        } catch (error) {
          console.error('Genel yükleme/karşılaştırma hatası:', error);
          showError(
            'Karşılaştırma sırasında bir hata oluştu: ' + error.message
          );
        } finally {
          loadingState.style.display = 'none';
          fileUploadCompareBtn.disabled = false;
        }
      }

      async function compareFromURL() {
        const file1 = document.getElementById('file1').files[0];
        const file2 = document.getElementById('file2').files[0];

        if (!file1 || !file2) {
          return alert('Lütfen karşılaştırmak için iki X3P dosyası seçin.');
        }

        hideAllSections();
        loadingState.style.display = 'block';
        fileUploadCompareBtn.disabled = true;

        try {
          // 3. Signed URL alma (60 saniye geçerli)

          const { data: signed1, error: urlErr1 } = await supabaseClient.storage
            .from('x3p-files')
            .createSignedUrl(`input/${file1.name}`, 60);

          const { data: signed2, error: urlErr2 } = await supabaseClient.storage
            .from('x3p-files')
            .createSignedUrl(`input/${file2.name}`, 60);

          if (
            urlErr1 ||
            urlErr2 ||
            !signed1?.signedUrl ||
            !signed2?.signedUrl
          ) {
            console.error(urlErr1 || urlErr2);
            showError(
              'Signed URL alınamadı. Policy veya dosya hatası olabilir. Lütfen Supabase Storage ayarlarınızı kontrol edin.'
            );
            return;
          }
          // 4. Supabase Edge Function çağır (Eğer kullanıyorsanız)
          const FUNCTION_URL =
            'https://wablvevlywlqifnezzdp.supabase.co/functions/v1/x3p-compare';
          // 4. Supabase Edge Function çağır
          const res = await fetch(FUNCTION_URL, {
            method: 'POST',
            body: JSON.stringify({
              url1: signed1.signedUrl,
              url2: signed2.signedUrl,
            }),
            headers: {
              'Content-Type': 'application/json',
            },
          });

          const json = await res.json();
          document.getElementById('output').textContent = JSON.stringify(
            json,
            null,
            2
          );

          // 5. Replit Function çağır (Ana mantık buradaysa)
          const DEEP_FUNCTION_URL =
            'https://a961e274-de91-4411-bf3f-124d9d49d4fb-00-v2anh336mm9f.picard.replit.dev/api/compare';
          const deep_res = await fetch(DEEP_FUNCTION_URL, {
            method: 'POST',
            body: JSON.stringify({
              url1: signed1.signedUrl,
              url2: signed2.signedUrl,
            }),
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (!deep_res.ok) {
            const errorText = await deep_res.text();
            throw new Error(
              `Replit API error: ${deep_res.status} ${deep_res.statusText} - ${errorText}`
            );
          }

          const deep_json = await deep_res.json(); // Raw JSON çıktısını bir yere yazdır (isteğe bağlı, debug için)

          // document.getElementById('output').textContent = JSON.stringify(deep_json, null, 2);

          displayResults(deep_json);
        } catch (error) {
          console.error('Genel yükleme/karşılaştırma hatası:', error);
          showError(
            'Karşılaştırma sırasında bir hata oluştu: ' + error.message
          );
        } finally {
          loadingState.style.display = 'none';
          fileUploadCompareBtn.disabled = false;
        }
      }
      document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('comparisonForm');
        const clearBtn = document.getElementById('clearBtn'); // URL karşılaştırma form submit olayı

        form.addEventListener('submit', async function (e) {
          e.preventDefault();

          const url1 = document.getElementById('url1').value;
          const url2 = document.getElementById('url2').value;

          if (!url1 || !url2) {
            showError("Lütfen her iki X3P dosya URL'sini de girin.");
            return;
          }

          hideAllSections();
          loadingState.style.display = 'block';
          compareBtn.disabled = true;

          try {
            // Bu kısım Replit'teki '/api/compare' endpoint'ini çağırır
            const response = await fetch('/api/compare', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ url1, url2 }),
            });

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(
                `API hatası: ${response.status} ${response.statusText} - ${errorText}`
              );
            }

            const data = await response.json();

            if (data.success) {
              displayResults(data);
            } else {
              showError(data.error || 'Bilinmeyen bir hata oluştu.');
            }
          } catch (error) {
            console.error('Error:', error);
            showError(
              'Ağ hatası veya API yanıtı işlenirken sorun: ' + error.message
            );
          } finally {
            loadingState.style.display = 'none';
            compareBtn.disabled = false;
          }
        }); // Clear butonu

        clearBtn.addEventListener('click', function () {
          form.reset();
          hideAllSections(); // Eğer output alanı varsa temizle
          const outputDiv = document.getElementById('output');
          if (outputDiv) {
            outputDiv.textContent = '';
          }
        });
      });
    </script>
  </body>
</html>
