<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Balistika Admin Paneli x3p Karşılaştırma</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  </head>
  <body class="p-5">
    <h3>.x3p Karşılaştırıcı</h3>

    <div class="mb-3">
      <input type="file" id="file1" class="form-control" />
      <input type="file" id="file2" class="form-control mt-2" />
      <button onclick="uploadAndCompare()" class="btn btn-primary mt-3">
        Karşılaştır
      </button>
    </div>

    <pre id="output"></pre>
    <script>
      const firebaseConfig = {
        apiKey: 'AIzaSyCBM_rIBwuBlm3UkvCd_R5UcBrGzHMd4so',
        authDomain: 'askque-729f3.firebaseapp.com',
        projectId: 'askque-729f3',
        storageBucket: 'askque-729f3.appspot.com',
        messagingSenderId: '218092354672',
        appId: '1:218092354672:web:226cb9c767058face1c8b5',
        measurementId: 'G-THZX3Y5C24',
      };

      firebase.initializeApp(firebaseConfig);

      firebase.auth().onAuthStateChanged(function (user) {
        if (!user) {
          // Giriş yapılmamışsa login sayfasına yönlendir
          window.location.href = 'login.html';
        } else {
          // Giriş yapılmışsa kullanıcıyı karşılama (isteğe bağlı)
          document.querySelector(
            '.navbar-text'
          ).textContent = `Hoş geldiniz, ${user.email}!`;
        }
      });

      const supabaseClient = supabase.createClient(
        'https://wablvevlywlqifnezzdp.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndhYmx2ZXZseXdscWlmbmV6emRwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3OTM2ODksImV4cCI6MjA2NDM2OTY4OX0.IUJi55B60PLAlDE5rlLX0xutm7u4UYVR4HGCmWwDxE4'
      );

      async function uploadAndCompare() {
        const file1 = document.getElementById('file1').files[0];
        const file2 = document.getElementById('file2').files[0];

        if (!file1 || !file2) {
          return alert('İki dosya da seçilmeli');
        }

        // 1. Dosya 1 yüklemesi
        const { error: uploadErr1 } = await supabaseClient.storage
          .from('x3p-files')
          .upload(`input/${file1.name}`, file1, { upsert: true });

        if (uploadErr1) {
          console.error(uploadErr1);
          return alert('Dosya 1 yüklenemedi: ' + uploadErr1.message);
        }

        // 2. Dosya 2 yüklemesi
        const { error: uploadErr2 } = await supabaseClient.storage
          .from('x3p-files')
          .upload(`input/${file2.name}`, file2, { upsert: true });

        if (uploadErr2) {
          console.error(uploadErr2);
          return alert('Dosya 2 yüklenemedi: ' + uploadErr2.message);
        }

        // 3. Signed URL alma
        const { data: signed1, error: urlErr1 } = await supabaseClient.storage
          .from('x3p-files')
          .createSignedUrl(`input/${file1.name}`, 60);

        const { data: signed2, error: urlErr2 } = await supabaseClient.storage
          .from('x3p-files')
          .createSignedUrl(`input/${file2.name}`, 60);

        if (urlErr1 || urlErr2 || !signed1?.signedUrl || !signed2?.signedUrl) {
          console.error(urlErr1 || urlErr2);
          return alert(
            'Signed URL alınamadı. Policy veya dosya hatası olabilir.'
          );
        }

        const FUNCTION_URL =
          'https://wablvevlywlqifnezzdp.supabase.co/functions/v1/x3p-compare';
        // 4. Supabase Edge Function çağır
        const res = await fetch(FUNCTION_URL, {
          method: 'POST',
          body: JSON.stringify({
            url1: signed1.signedUrl,
            url2: signed2.signedUrl,
          }),
          headers: {
            'Content-Type': 'application/json',
          },
        });

        const json = await res.json();
        document.getElementById('output').textContent = JSON.stringify(
          json,
          null,
          2
        );
      }
    </script>
  </body>
</html>
